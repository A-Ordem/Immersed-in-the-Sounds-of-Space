<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Web Audio API examples: Basics</title>
  <meta name="description" content="Audio basics demo for Web Audio API" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="stylesheet" type="text/css" href="style.css" />
</head>

<body>
  <!--<input type="file" id="inputFile" accept="image/*">-->
  <input type="file" id="imageInput" accept="image/*">

  <div id="boombox">
    <div class="boombox-handle"></div>

    <div class="boombox-body">
      <section class="tape">
        <!-- <audio src="outfoxing.mp3" crossorigin="anonymous"></audio> -->
        <audio src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/858/outfoxing.mp3" crossorigin="anonymous"></audio>

        <!-- 			type="audio/mpeg" -->
        <button data-playing="false" class="tape-controls-play" role="switch" aria-checked="false">
          <span>Play/Pause</span>
        </button>
        <button id="generateMusic">Generate Music</button>
        <canvas id="imageCanvas"></canvas>
      </section>
    </div>
    <!-- boombox-body -->
  </div>

  <!-- ------------------------------------------------------------------------------------ -->
  <script src="wavetable.js"></script>
  <script type="text/javascript">
    console.clear();

    // instigate our audio context
    //let audioCtx;
    const audioCtx = new AudioContext();

    // load some sound
    const audioElement = document.querySelector("audio");
    let track;

    const playButton = document.querySelector(".tape-controls-play");

    // play pause audio
    playButton.addEventListener(
      "click",
      () => {
        if (!audioCtx) {
          init();
        }

        // check if context is in suspended state (autoplay policy)
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }

        if (playButton.dataset.playing === "false") {


          // if track is playing pause it
        } else if (playButton.dataset.playing === "true") {
          //audioElement.pause();
          playButton.dataset.playing = "false";
        }

        // Toggle the state between play and not playing
        let state =
          playButton.getAttribute("aria-checked") === "true" ? true : false;
        playButton.setAttribute("aria-checked", state ? "false" : "true");
      },
      false
    );

    // If track ends
    audioElement.addEventListener(
      "ended",
      () => {
        playButton.dataset.playing = "false";
        playButton.setAttribute("aria-checked", "false");
      },
      false
    );

    // Selecione o elemento de entrada de arquivo
    const imageInput = document.getElementById('imageInput');
    const musicPlayer = document.getElementById('musicPlayer');
    const generateMusicButton = document.getElementById('generateMusic');
    const imageCanvas = document.getElementById('imageCanvas');
    let pixelData = null;

    let memoryCard = []

    imageInput.addEventListener('change', function () {
      const file = imageInput.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = new Image();
          img.src = e.target.result;
          img.onload = function () {
            imageCanvas.width = img.width;
            imageCanvas.height = img.height;
            const ctx = imageCanvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            pixelData = ctx.getImageData(0, 0, img.width, img.height).data;
            generateMusicButton.disabled = false;

            // Tamanho do quadrado de pixels (largura e altura)
            const altura = Math.floor(img.height / 7);
            const largura = Math.floor(img.width / 7);

            // Coordenadas do canto superior esquerdo do quadrado
            let startX = 0;
            let startY = 0;

            for (let i = 0; i < 49; i++) {
              startX = (i % 7) * largura;
              startY = Math.floor(i / 7) * altura;

              // VariÃ¡veis para calcular a soma dos valores de pixel
              let somaR = 0;
              let somaG = 0;
              let somaB = 0;
              for (let y = startY; y < startY + altura; y++) {
                for (let x = startX; x < startX + largura; x++) {
                  const index = (y * img.width + x) * 4;
                  somaR += pixelData[index];
                  somaG += pixelData[index + 1];
                  somaB += pixelData[index + 2];
                }
              }

              const numPixels = altura * largura;
              const mediaR = Math.floor(somaR / numPixels);
              const mediaG = Math.floor(somaG / numPixels);
              const mediaB = Math.floor(somaB / numPixels);
              /*
              console.log(i);
              console.log("R: ");
              console.log(mediaR);
              console.log("G: ");
              console.log(mediaG);
              console.log("B: ");
              console.log(mediaB);
              console.log(" ");
              */
              memoryCard.push(Math.floor((mediaR + mediaG + mediaB) / 3))
              memoryCard.push(i)
            };
            console.log(memoryCard);
          };
        };
        reader.readAsDataURL(file);
      }
    });

    generateMusicButton.addEventListener('click', function () {
      if (!memoryCard) {
        alert('Please select an image first.');
        return;
      }

      let media = 0
      for (let i = 0; i < 98; i += 2) {
        media += memoryCard[i]
      }
      media /= 49
      let filtro = 0
      for (let i = 0; i < 98; i += 2) {
        filtro += Math.pow((media-memoryCard[i]), 2);
      }
      filtro /= (49*49)
      Math.sqrt(filtro)
      filtro = 2*filtro + media
      console.log(media)
      console.log(filtro)

      let filtrada = []
      for (let i = 0; i < 98; i += 2) {
        if (memoryCard[i] > filtro) {//&& filtrada.length < 7
          filtrada.push(memoryCard[i])
          filtrada.push(memoryCard[i+1])
        }
      }
      // Generate music from pixelData
      console.log(filtrada)
      const musica = generateMusicFromPixelData(filtrada);
    });

    function generateMusicFromPixelData(pontos) {

      //audioElement.play();
      playButton.dataset.playing = "true";

      ////////////////////////////////////////////////////////// Perigo ///////////////////////////////////////

      let attackTime = 0.5;
      let releaseTime = 0.5;

      let wave = new PeriodicWave(audioCtx, {
        real: wavetable.real,
        imag: wavetable.imag,
      });

      // Expose attack time & release time
      const sweepLength = 1;
      function playSweep(time, freq, panVal) {

        const osc = new OscillatorNode(audioCtx, {
          frequency: freq,
          type: "custom",
          periodicWave: wave,
        });

        // Create the node that controls the volume.
        const gainNode = new GainNode(audioCtx);
        gainNode.gain.value = 0.4;//0 - 2

        // Create the node that controls the panning
        const panner = new StereoPannerNode(audioCtx, { pan: 0 });
        panner.pan.value = panVal; //-1 - 1

        osc.connect(gainNode).connect(panner).connect(audioCtx.destination);
        osc.start(time);
        osc.stop(time + sweepLength);
      }

      ////////////////////////////////////////////////////////// Tocando ///////////////////////////////////////////////////
      let time = 2
      /*
      wave = new PeriodicWave(audioCtx, {
        real: wavetable.real,
        imag: wavetable.imag,
      });
      playSweep(time, 300, -1);

      wave = new PeriodicWave(audioCtx, {
        real: wavetableP.real,
        imag: wavetableP.imag,
      });
      playSweep(time, 1000, 1);
      */
      
      for (let i = 0; i < pontos.length; i += 2) {
        let lateral = ((i+1 % 7)-4)/4
        let oitava = 1
        let vertical = Math.floor(i/7)*oitava
        const notas = [130, 150*2, 165*3, 175*4, 200*5, 221*6, 230*7]
        playSweep(time, notas[vertical], lateral);
      }

    }

    // Track credit: Outfoxing the Fox by Kevin MacLeod under Creative Commons
  </script>
</body>

</html>